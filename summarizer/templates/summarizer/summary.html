<!-- summarizer_project/summarizer/templates/summarizer/summary.html -->

{% extends 'summarizer/base.html' %}

{% block title %}Generated Summary{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Generated Summary</h2>
    
    <div id="notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300"></div>

    <!-- Editable Summary -->
    <div class="mb-6">
        <label for="summary-text" class="block text-lg font-semibold text-gray-700 mb-2">Edit your summary:</label>
        <textarea id="summary-text" class="w-full h-96 p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">{{ transcript.summary_text }}</textarea>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
        <button id="save-btn" class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
            Save Changes
        </button>
        <button id="share-btn" class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
            Share via Email
        </button>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Share Summary</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 mb-4">Enter recipient email addresses, separated by commas.</p>
                            <input type="text" id="recipient-emails" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="email1@example.com, email2@example.com">
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="send-email-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    Send
                </button>
                <button type="button" id="close-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-btn');
    const shareBtn = document.getElementById('share-btn');
    const modal = document.getElementById('share-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const sendEmailBtn = document.getElementById('send-email-btn');
    const summaryText = document.getElementById('summary-text');
    const transcriptId = '{{ transcript.id }}';
    const notification = document.getElementById('notification');

    function showNotification(message, isError = false) {
        notification.textContent = message;
        notification.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
        notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    }

    // Save functionality
    if(saveBtn) {
        saveBtn.addEventListener('click', () => {
            const updatedSummary = summaryText.value;
            fetch(`/summary/update/${transcriptId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ summary_text: updatedSummary })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification(data.message);
                } else {
                    showNotification(data.message, true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An unexpected error occurred.', true);
            });
        });
    }

    // Modal functionality
    if(shareBtn) {
        shareBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });
    }
    
    if(closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
    }

    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            modal.classList.add('hidden');
        }
    });

    // Email sending functionality
    if(sendEmailBtn) {
        sendEmailBtn.addEventListener('click', () => {
            const recipients = document.getElementById('recipient-emails').value;
            if (!recipients) {
                showNotification('Please enter at least one recipient.', true);
                return;
            }
            
            const formData = new FormData();
            formData.append('recipients', recipients);

            fetch(`/summary/share/${transcriptId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                modal.classList.add('hidden');
                if (data.status === 'success') {
                    showNotification(data.message);
                } else {
                    showNotification(data.message, true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                modal.classList.add('hidden');
                showNotification('An unexpected error occurred while sending email.', true);
            });
        });
    }
});
</script>
{% endblock %}